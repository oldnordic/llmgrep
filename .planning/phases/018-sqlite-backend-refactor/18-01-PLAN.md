---
phase: 18-sqlite-backend-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/sqlite.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SqliteBackend stores db_path field for magellan shell-out in ast/find_ast"
    - "All helper functions from query.rs are moved to SqliteBackend as private methods"
    - "Helper functions are verbatim copies (no logic changes)"
    - "Code compiles after helper function migration"
  artifacts:
    - path: "src/backend/sqlite.rs"
      provides: "SqliteBackend with db_path field and private helper methods"
      exports: ["SqliteBackend", "extract_symbol_content_safe", "walk_files_for_symbol", "calculate_byte_offsets"]
      covered_by: "Task 1"
  key_links:
    - from: "src/query.rs"
      to: "src/backend/sqlite.rs"
      via: "verbatim code migration"
      pattern: "fn extract_symbol_content_safe|fn walk_files_for_symbol|fn calculate_byte_offsets"
---

<objective>
Add db_path field to SqliteBackend and move helper functions from query.rs to SqliteBackend as private methods.

Purpose: Establish the foundation for SqliteBackend trait implementation by adding required state and migrating helper code without breaking existing functionality.
Output: SqliteBackend struct with db_path field and private helper methods for symbol content extraction.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/017-backend-infrastructure/17-01-SUMMARY.md
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/query.rs
@src/backend/sqlite.rs
@src/backend/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add db_path field to SqliteBackend and migrate helper functions</name>
  <files>src/backend/sqlite.rs</files>
  <action>
    1. Update SqliteBackend struct to add `db_path: PathBuf` field:
       ```rust
       pub struct SqliteBackend {
           pub(crate) conn: Connection,
           db_path: PathBuf,  // Add this field
       }
       ```

    2. Update SqliteBackend::open() to store db_path:
       ```rust
       pub fn open(db_path: &Path) -> Result<Self, LlmError> {
           let conn = Connection::open(db_path)?;
           Ok(Self {
               conn,
               db_path: db_path.to_path_buf(),
           })
       }
       ```

    3. Move the following helper functions from query.rs to SqliteBackend as private methods:
       - `extract_symbol_content_safe()` - Already re-exported from magellan, just use the re-export
       - `walk_files_for_symbol()` - Lines ~200-350 in query.rs, move verbatim
       - `calculate_byte_offsets()` - Lines ~350-450 in query.rs, move verbatim

    4. For `walk_files_for_symbol` and `calculate_byte_offsets`, change signature to take `&self` instead of standalone:
       ```rust
       impl SqliteBackend {
           fn walk_files_for_symbol(
               &self,
               root_path: &Path,
               symbol_id: &str,
               glob_matcher: &Option<GlobMatcher>,
               glob_matcher_includes: &Option<GlobMatcher>,
               ignore: &Ignore,
               conn: &Connection,  // Keep conn param for now
           ) -> Result<Vec<SymbolReference>, LlmError> {
               // ... verbatim code from query.rs ...
           }
       }
       ```

    5. Add required imports to sqlite.rs:
       - `use std::path::PathBuf;`
       - `use ignore::Ignore;`
       - `use globset::GlobMatcher;`
       - `use crate::output::SymbolReference;` (if needed)

    NOTE: extract_symbol_content_safe is already re-exported from magellan in safe_extraction.rs, so we can use it directly via the re-export. No need to move it.
  </action>
  <verify>cargo build 2>&1 | head -50</verify>
  <done>SqliteBackend has db_path field, helper functions are private methods, code compiles</done>
</task>

</tasks>

<verification>
1. cargo build succeeds without errors
2. SqliteBackend struct has db_path field in sqlite.rs
3. walk_files_for_symbol and calculate_byte_offsets are now private methods on SqliteBackend
4. No logic changes from query.rs versions (verbatim copy)
</verification>

<success_criteria>
- [ ] SqliteBackend stores db_path for ast/find_ast shell-out
- [ ] Helper functions moved to SqliteBackend as private methods
- [ ] Code compiles without errors
- [ ] No logic changes (verbatim code migration)
</success_criteria>

<output>
After completion, create `.planning/phases/018-sqlite-backend-refactor/18-01-SUMMARY.md`
</output>
