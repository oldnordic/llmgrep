---
phase: 18-sqlite-backend-refactor
plan: 03
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/query.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "search_references_impl() function exists taking &Connection parameter"
    - "search_references_impl() contains verbatim SQL query logic from search_references()"
    - "query.rs::search_references() calls search_references_impl() as wrapper"
    - "Code compiles after _impl() function creation"
  artifacts:
    - path: "src/query.rs"
      provides: "search_references_impl() internal function for search_references logic"
      exports: ["search_references_impl"]
      covered_by: "Task 1"
  key_links:
    - from: "src/query.rs::search_references"
      to: "src/query.rs::search_references_impl"
      via: "function call wrapper"
      pattern: "search_references_impl\\(conn, options\\)"
---

<objective>
Create search_references_impl() internal function that takes &Connection parameter, containing the core search_references SQL query logic.

Purpose: Separate "how to query" (internal implementation with explicit Connection) from "where to get connection" (trait method with &self.conn).
Output: search_references_impl() function in query.rs with verbatim search_references logic.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/018-sqlite-backend-refactor/18-01-SUMMARY.md
@.planning/phases/018-sqlite-backend-refactor/18-02-SUMMARY.md
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/query.rs
@src/backend/sqlite.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search_references_impl() with Connection parameter</name>
  <files>src/query.rs</files>
  <action>
    1. Create new public(crate) function `search_references_impl()` in query.rs:
       ```rust
       pub(crate) fn search_references_impl(
           conn: &Connection,
           options: &SearchOptions,
       ) -> Result<(ReferenceSearchResponse, bool), LlmError>
       ```

    2. Copy the ENTIRE body of `search_references()` (lines ~958-1192 in query.rs) into `search_references_impl()`.

    3. Make the following modifications to the copied code:
       - Remove the `Connection::open_with_flags()` call at the beginning (conn is now a parameter)
       - Remove the database validation query (conn is already valid)
       - Keep all other logic verbatim

    4. Update the original `search_references()` function to be a wrapper (same pattern as search_symbols):
       ```rust
       pub fn search_references(options: SearchOptions) -> Result<(ReferenceSearchResponse, bool), LlmError> {
           // Connection opening and validation (keep existing code pattern from search_symbols)
           let conn = match Connection::open_with_flags(options.db_path, OpenFlags::SQLITE_OPEN_READ_ONLY) {
               // ... same error handling as search_symbols ...
           };

           // Validation
           conn.query_row("SELECT name FROM sqlite_master WHERE type='table' LIMIT 1", [], |_| Ok(()))
               .map_err(|e| /* same error handling */)?;

           // Call the implementation
           search_references_impl(&conn, &options)
       }
       ```

    5. Verify no logic changes: The SQL queries, scoring, filtering, and post-processing must be identical.
  </action>
  <verify>cargo test --lib search_tests::search_references 2>&1 | tail -20</verify>
  <done>search_references_impl() exists with Connection parameter, search_references() is wrapper, tests pass</done>
</task>

</tasks>

<verification>
1. search_references_impl() function exists in query.rs with signature (conn: &Connection, options: &SearchOptions)
2. search_references() function calls search_references_impl(&conn, &options)
3. All search_references unit tests pass
4. SQL query logic is verbatim from original search_references()
</verification>

<success_criteria>
- [ ] search_references_impl() created with Connection parameter
- [ ] search_references() wrapper maintains test compatibility
- [ ] All existing search_references tests pass
- [ ] No logic changes (verbatim SQL copy)
</success_criteria>

<output>
After completion, create `.planning/phases/018-sqlite-backend-refactor/18-03-SUMMARY.md`
</output>
